# 旅游规划助手 - 技术架构与实现思路

## 项目概述

本项目基于 Langchain 官方的 `deepagents` 进行深度改写，成功适配国内顶尖大语言模型，采用 LangGraph 框架构建旅游规划助手。系统通过多智能体协作机制，为用户提供个性化、专业化的旅游规划。

## 1. 系统架构概览

### 1.1 整体架构

系统采用多智能体架构：

![系统架构图](./assets/graph.png)

- **主智能体**：承担需求分析、任务拆解和智能调度职责，将复杂旅游需求分解为可执行的子任务
- **子智能体**：专注于具体任务执行，利用专业知识完成各项子任务并返回高质量结果

### 1.2 技术栈

- **核心框架**：LangGraph
- **基础模型**：适配国内顶尖模型（如 Qwen、DeepSeek 等）
- **工具库**：langchain-dev-utils (LangChain 实用工具项目)

## 2. 状态图编写

### 2.1 状态定义

```python
# 输入状态
class StateInput(MessagesState):
    pass

# 主智能体状态
class State(MessagesState, PlanStateMixin, NoteStateMixin, total=False):
    task_messages: Annotated[list[AnyMessage], add_messages]

# 子智能体状态
class SubAgentState(MessagesState, NoteStateMixin, total=False):
    temp_task_messages: Annotated[list[AnyMessage], add_messages]
```

### 2.2 核心状态字段

#### 2.2.1 Plan 字段 - 任务计划管理

`plan` 字段用于存储待办事项列表，是任务管理的核心。本项目引入了两个专用工具：

**write_plan 工具**

- **功能**：创建初始待办事项列表并启动第一个任务
- **输入参数**：`List[str]` - 字符串列表，每个字符串代表一条待办事项内容
- **实现逻辑**：
  1. 将输入字符串转换为标准化待办对象：`{"content": "待办事项内容", "status": "pending"}`
  2. 自动将第一条待办事项状态设置为 `in_progress`，实现任务自动启动
  3. 将完整的待办列表存储在状态的 `plan` 字段中
- **返回值**：创建成功的待办事项列表及状态信息

**update_plan 工具**

- **功能**：增量更新待办事项状态，支持批量状态变更
- **输入参数**：`List[Dict[str, str]]` - 字典列表，每个字典包含：
  - `content`: 待办事项的具体内容（用于匹配）
  - `status`: 目标状态，仅支持 `"done"` 或 `"in_progress"`
- **约束条件**：
  - 每次调用必须同时包含 `"done"` 和 `"in_progress"` 状态的项目
  - 所有传入的待办事项必须在现有 plan 列表中存在对应项
- **实现逻辑**：
  1. 验证输入参数的合法性和匹配性
  2. 原子性更新 plan 字段中的对应项目状态
  3. 抛出异常处理不匹配的待办事项
- **错误处理**：当传入无法匹配的待办事项时，抛出异常并提示 LLM 参数错误

#### 2.2.2 与官方项目对比

与官方版本相比，本设计采用分离式工具策略，具有以下优势：

**Token 使用优化**

- 官方版本：每次更新需传递完整待办列表
- 本项目：仅传递变化的项目，显著减少 token 消耗

**示例对比**

```python
# 场景：待办事项 [任务1, 任务2, 任务3, 任务4] 中任务1完成，开始任务2

# 官方方式 - 传递完整列表
official_update = [
    {"content": "任务1", "status": "done"},
    {"content": "任务2", "status": "in_progress"},
    {"content": "任务3", "status": "pending"},
    {"content": "任务4", "status": "pending"}
]

# 优化方式 - 仅传递变化项
optimized_update = [
    {"content": "任务1", "status": "done"},
    {"content": "任务2", "status": "in_progress"}
]

```

#### 2.2.3 Note 字段 - 抽象文件系统

`note` 字段实现了基于 LangGraph 状态的抽象文件系统，作为智能体间的信息共享机制：

- **存储结构**：`Dict[str, str]` - 字典形式，文件名作为键，文件内容作为值
- **核心特性**：
  - 非真实文件系统，而是 LangGraph 状态的内存抽象
  - 支持跨智能体的持久化信息存储和检索
  - 提供文件系统的基础操作接口
- **核心工具**：
  - `write_note(filename: str, content: str)`：写入指定文件内容
  - `ls()`：返回当前存储的文件名列表
  - `query_note(filename: str)`：查询并返回指定文件内容

#### 2.2.4 消息队列设计

- **task_messages**：`Annotated[list[AnyMessage], add_messages]`

  - 用途：存储子智能体的完整对话历史
  - 特性：使用 `add_messages` 注解确保消息的正确追加和去重
  - 生命周期：跨多个子任务执行保持持久化

- **temp_task_messages**：`Annotated[list[AnyMessage], add_messages]`
  - 用途：子智能体单次执行的临时上下文窗口
  - 特性：每次任务执行时重新创建，确保上下文隔离
  - 生命周期：单次任务执行期间有效，执行后关键信息传递给 task_messages

---

## 3. 上下文管理机制

### 3.1 上下文隔离策略

#### 3.1.1 状态隔离

- **主智能体**：使用 `message` 字段存储主智能体消息列表
- **子智能体**：使用 `temp_task_messages` 作为临时执行上下文
- **消息隔离**：两个消息队列完全独立，避免上下文污染

#### 3.1.2 执行流程隔离

- **独立上下文**：子智能体每次执行创建全新的 `temp_task_messages` 上下文
- **信息传递**：执行完成后，仅关键信息通过摘要形式传递回主智能体
- **任务隔离**：确保子任务间完全隔离，每个子任务在干净环境中执行
- **状态保存**：子智能体执行完成后，将现有的临时上下文内容存入 `task_messages`

#### 3.1.3 LangGraph 子图实现

- **子图构建**：通过 `build_sub_agent` 函数创建独立的子图结构
- **状态管理**：子图拥有独立的状态管理机制和节点流转逻辑
- **任务委派**：主图通过 `transform_task_to_subagent` 工具将任务委派给子图执行
- **生命周期**：子图在任务执行期间激活，完成后返回结果并销毁

### 3.2 KVCache 优化策略

主智能体需要多轮工具调用来执行 todo list 管理和任务分配，KVCache 优化策略如下：

- **消息追加机制**：每次产生的 AIMessage 和 ToolMessage 追加到消息列表后部
- **缓存结构保护**：不破坏原有 KVCache 的键值对结构，保持缓存一致性
- **性能提升原理**：
  - 减少重复的模型推理计算
  - 提高响应速度和系统吞吐量
  - 降低 API 调用成本

### 3.3 基于 Note 的上下文共享机制

**主智能体工具策略**

- **完整工具集**：`ls`、`query_note` 等
- **按需查询**：仅在确切需要完整子任务结果时调用 `query_note`（实际运行很少会调用）
- **职责聚焦**：专注于任务分解和调度，避免加载大量笔记内容破坏 KV Cache

**子智能体工具策略**

- **告知模式**：系统提示词直接列出可用笔记名称
- **独立上下文**：由于运行在独立上下文窗口，直接拼接历史笔记不影响 KV Cache
- **自主决策**：子智能体根据任务性质自主决定是否查询历史笔记

**技术影响力**

- **行业标准推动**：推动多智能体协作在旅游行业的标准化应用
- **开源社区贡献**：将核心技术方案开源，促进技术交流和发展
- **学术研究支持**：为相关学术研究提供实践基础和数据支持

## 4. 结语

本项目不仅成功解决了旅游规划的实际问题，更重要的是在多智能体协作、状态管理、上下文隔离等关键技术领域实现了重要突破。这些技术创新不仅适用于旅游规划场景，也为其他复杂的多智能体应用提供了有价值的参考和借鉴。

我们相信，随着技术的不断发展和完善，这种创新的多智能体协作模式将在更多领域发挥重要作用，推动人工智能技术的实际应用和产业化进程。
